---
title: Azure에서 VM 백업 인프라 계획 | Microsoft Docs
description: Azure에서 가상 머신을 백업하려고 할 때 중요한 고려 사항
services: backup
documentationcenter: ''
author: markgalioto
manager: carmonm
editor: ''
keywords: vm 백업, virtual machines 백업
ms.assetid: 19d2cf82-1f60-43e1-b089-9238042887a9
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 3/23/2018
ms.author: markgal;trinadhk;sogup
ms.openlocfilehash: 299794b100ed438de2995d70419025dd686d2278
ms.sourcegitcommit: 1362e3d6961bdeaebed7fb342c7b0b34f6f6417a
ms.translationtype: HT
ms.contentlocale: ko-KR
ms.lasthandoff: 04/18/2018
---
# <a name="plan-your-vm-backup-infrastructure-in-azure"></a>Azure에서 VM 백업 인프라 계획
이 문서에서는 성능 및 리소스를 제안하여 VM 백업 인프라를 계획할 수 있도록 합니다. 또한 Backup 서비스의 핵심 요소를 정의합니다. 이러한 측면은 아키텍처, 용량 계획 및 예약을 결정하는 데 중요한 요인이 될 수 있습니다. [환경을 준비](backup-azure-arm-vms-prepare.md)했다면 계획은 [VM 백업](backup-azure-arm-vms.md)을 시작하기 전의 다음 단계입니다. Azure Virtual Machines에 대한 자세한 내용은 [Virtual Machines 설명서](https://azure.microsoft.com/documentation/services/virtual-machines/)를 참조하세요.

## <a name="how-does-azure-back-up-virtual-machines"></a>Azure에서 가상 머신을 백업하는 방법
Azure Backup 서비스가 예약된 시간에 백업 작업을 시작할 때 해당 서비스는 시점 스냅숏을 만드는 백업 확장을 트리거합니다. Azure Backup 서비스는 Windows에서 _VMSnapshot_ 확장을 사용하고, Linux에서는 _VMSnapshotLinux_ 확장을 사용합니다. 확장은 첫 번째 VM 백업 중에 설치됩니다. 확장을 설치하려면 VM이 실행 중이어야 합니다. VM이 실행되고 있지 않을 경우 Backup 서비스가 기본 저장소의 스냅숏을 생성합니다(VM이 중지되었을 때는 응용 프로그램 쓰기가 수행되지 않음).

Windows VM의 스냅숏을 생성할 때 Backup 서비스는 가상 머신의 디스크에 대한 일관된 스냅숏을 가져오도록 VSS(볼륨 섀도 복사본 서비스)와 조정됩니다. Linux VM을 백업하는 경우 VM 스냅숏을 생성할 때 일관성을 유지하기 위해 직접 사용자 지정 스크립트를 작성할 수 있습니다. 이러한 스크립트 호출에 대한 자세한 내용은 이 문서의 뒷부분에 제공됩니다.

Azure Backup 서비스가 스냅숏을 생성하면 데이터가 자격 증명 모음으로 전송됩니다. 효율성을 극대화하기 위해 이 서비스는 이전 백업 이후에 변경된 데이터 블록만 식별하여 전송합니다.

![Azure 가상 머신 백업 아키텍처](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

데이터 전송이 완료되면 스냅숏이 제거되고 복구 지점이 생성됩니다.

> [!NOTE]
> 1. Azure Backup은 백업 프로세스 중에 가상 머신에 연결된 임시 디스크를 포함하지 않습니다. 자세한 내용은 [임시 저장소](https://blogs.msdn.microsoft.com/mast/2013/12/06/understanding-the-temporary-drive-on-windows-azure-virtual-machines/)에 대한 블로그를 참조하세요.
> 2. Azure Backup은 저장소 수준의 스냅숏을 생성하여 자격 증명 모음으로 전송하므로 백업 작업이 완료될 때까지 저장소 계정 키를 변경하지 마세요.
> 3. 프리미엄 VM에서 Azure Backup은 저장소 계정에 스냅숏을 복사합니다. 이렇게 하면 Backup 서비스가 자격 증명 모음으로 데이터를 전송하는 데 충분한 IOPS를 사용하게 됩니다. 이러한 추가 저장소 복사본은 VM 할당 크기를 기준으로 대금이 청구됩니다. 
>

### <a name="data-consistency"></a>데이터 일관성
데이터를 생성하는 응용 프로그램이 실행되는 동안에 업무에 중요한 데이터가 백업되어야 하므로 이러한 데이터를 백업하고 복원하는 것은 복잡합니다. 이를 해결하기 위해 Azure Backup은 Windows와 Linux VM에 대해 응용 프로그램 일치 백업을 지원합니다.
#### <a name="windows-vm"></a>Windows VM
Windows VM에서 Azure Backup은 VSS 전체 백업을 사용합니다( [VSS 전체 백업](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)에 대해 자세히 알아보기). VSS 복사본 백업을 사용하도록 설정하려면 VM에서 다음 레지스트리 키를 설정해야 합니다.

```
[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
"USEVSSCOPYBACKUP"="TRUE"
```

#### <a name="linux-vms"></a>Linux VM
Azure Backup은 스크립팅 프레임워크를 제공합니다. Linux VM을 백업할 때 응용 프로그램 일관성을 보장하려면 백업 워크플로 및 환경을 제어하는 사용자 지정 사전 스크립트 및 사후 스크립트를 만드세요. Azure Backup은 VM 스냅숏을 생성하기 전에 사전 스크립트를 호출하고 VM 스냅숏 작업이 완료되면 사후 스크립트를 호출합니다. 자세한 내용은 [사전 스크립트 및 사후 스크립트를 사용하여 응용 프로그램 일치 VM 백업](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent)을 참조하세요.
> [!NOTE]
> Azure Backup은 고객이 작성한 사전 및 사후 스크립트만 호출합니다. Azure Backup은 사전 스크립트 및 사후 스크립트가 성공적으로 실행되는 경우 응용 프로그램 일치로 복구 지점을 표시합니다. 그러나 사용자 지정 스크립트를 사용하는 경우 고객은 응용 프로그램 일관성에 궁극적으로 책임을 져야 합니다.
>


다음 표에서는 Azure VM 백업 및 복원 절차 중에 발생하는 조건 및 일관성 유형을 설명합니다.

| 일관성 | VSS 기반 | 설명 및 세부 정보 |
| --- | --- | --- |
| 응용 프로그램 일관성 |Windows 경우 예|응용 프로그램 일관성은 다음을 보장하므로 워크로드에 이상적입니다.<ol><li> VM이 *부팅*됩니다. <li>*손상이 없습니다*. <li>*데이터 손실*이 없습니다.<li> 데이터는 백업 시 VSS 또는 사전/사후 스크립트를 사용하는 응용 프로그램을 포함하여 데이터를 사용하는 응용 프로그램과 일치됩니다.</ol> <li>*Windows VM* - 대부분의 Microsoft 워크로드에는 데이터 일관성과 관련된 워크로드 관련 동작을 수행하는 VSS 작성자가 있습니다. 예를 들어 Microsoft SQL Server에는 트랜잭션 로그 파일에 대한 쓰기를 확인하고 데이터베이스가 제대로 수행되었는지 확인하는 VSS 작성자가 있습니다. Azure Windows VM 백업의 경우, 응용 프로그램에 일관된 복구 지점을 생성하려면 백업 확장이 VSS 워크플로를 호출하고 VM 스냅숏을 촬영하기 전에 완료해야 합니다. Azure VM 스냅숏이 정확하려면 모든 Azure VM 응용 프로그램의 VSS 기록기도 완료해야 합니다. [VSS 기본 사항](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx)(영문) 및 [작동 방법](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx)(영문)에서 자세히 알아 보세요. </li> <li> *Linux VM* - 고객은 [응용 프로그램 일관성을 보장하기 위해 사용자 지정 사전 스크립트 및 사후 스크립트를](https://docs.microsoft.com/azure/backup/backup-azure-linux-app-consistent) 실행할 수 있습니다. </li> |
| 파일 시스템 일관성 |예 - Windows 기반 컴퓨터 |복구 지점이 *일관된 파일 시스템*일 수 있는 두 가지 시나리오는 다음과 같습니다.<ul><li>사전 스크립트/사후 스크립트 없이 또는 사전 스크립트/사후 스크립트가 실패한 경우 Azure에서 Linux VM의 Backup. <li>Azure에서 Windows VM을 백업하는 중에 VSS 오류가 발생합니다.</li></ul> 두 경우 모두 다음을 보장하는 것이 가장 좋습니다. <ol><li> VM이 *부팅*됩니다. <li>*손상이 없습니다*.<li>*데이터 손실*이 없습니다.</ol> 응용 프로그램은 복원된 데이터에 대해 고유한 "수정" 메커니즘을 구현해야 합니다. |
| 충돌 일관성 |아니오 |이 상황은 "충돌"이 발생하는 가상 머신과 같습니다(소프트 또는 하드 재설정을 통해). 충돌 일관성은 일반적으로 Azure 가상 컴퓨터가 백업 시 종료될 때 발생합니다. 일관된 복구 지점에 충돌이 있다는 것은 저장소 매체의 데이터에 일관성을 보장해 주지 않는다는 뜻입니다(OS 관점 또는 응용 프로그램의 관점에서). 백업 시 디스크에 이미 존재하는 데이터만 캡처 및 백업됩니다. <br/> <br/> 보장은 없지만 대부분의 경우에 OS는 부팅됩니다. 이는 손상 오류를 수정하기 위한 chkdsk와 같은 디스크 검사 과정 이후에 발생합니다. 메모리 내 데이터 또는 디스크로 이전되지 않은 쓰기는 손실됩니다. 일반적으로 응용 프로그램은 데이터 롤백 작업을 수행해야 하는 경우에 고유한 확인 매커니즘을 수행합니다. <br><br>예를 들어 트랜잭션 로그에 데이터베이스에 없는 항목이 있는 경우 데이터베이스 소프트웨어는 데이터가 일관성을 찾을 때가지 롤백합니다. 여러 가상 디스크(예: 스팬 볼륨)에 분산된 데이터의 경우 충돌-일관성 복구 지점은 데이터 정확성을 보장하지 않습니다. |

## <a name="performance-and-resource-utilization"></a>성능 및 리소스 사용률
온-프레미스에 배포되는 백업 소프트웨어와 마찬가지로 Azure에서 VM을 백업하는 경우 용량 및 리소스 사용률에 대한 계획을 세워야 합니다. [Azure Storage 제한](../azure-subscription-service-limits.md#storage-limits) 은 워크로드 실행에 대한 영향을 최소화하면서 최대의 성능을 얻기 위한 VM 배포 구성 방법을 정의합니다.

백업 성능을 계획할 때 다음과 같은 Azure Storage 제한에 주의해야 합니다.

* 저장소 계정당 최대 송신
* 저장소 계정당 총 요청 속도

### <a name="storage-account-limits"></a>Storage 계정 제한
Backup 데이터가 저장소 계정에서 복사되면 저장소 계정의 초당 입력/출력 작업(IOPS) 및 송신(또는 처리량) 메트릭에 가산됩니다. 동시에 가상 머신도 실행되어 IOPS와 처리량을 사용합니다. 목표는 Backup 및 가상 컴퓨터 트래픽이 저장소 계정 한도를 초과하지 않도록 하는 것입니다.

### <a name="number-of-disks"></a>디스크 수
백업 프로세스에서는 백업 작업을 가능한 한 빨리 완료하려고 합니다. 이렇게 하면 가능한 많은 리소스를 소모합니다. 그러나 모든 I/O 작업은 초당 60MB의 제한이 있는 *단일 Blob의 목표 처리량*에 의해 제한됩니다. 해당 속도를 최대화하기 위해 백업 프로세스에서는 각 VM의 디스크를 *병렬로*백업하려고 합니다. VM에 4개의 디스크가 있는 경우, 이 서비스는 4개의 디스크를 모두 병렬로 백업하게 됩니다. 저장소 계정 백업 트래픽을 결정하는 가장 중요한 요소는 백업하는 **디스크 수**입니다.

### <a name="backup-schedule"></a>Backup 일정
성능에 영향을 주는 추가 요소는 **백업 일정**입니다. 모든 VM이 동시에 백업하도록 정책을 구성한 경우 트래픽 정체가 발생합니다. 백업 프로세스는 동시에 모든 디스크를 백업하려고 합니다. 저장소 계정에서 백업 트래픽을 줄이려면 여러 VM이 겹치지 않게 하루 중 서로 다른 시간대에 백업되도록 하는 것입니다.

## <a name="capacity-planning"></a>용량 계획
이전 요소를 모두 종합하여 저장소 계정 사용 요구 사항을 계획해야 합니다. [VM 백업 용량 계획 Excel 스프레드시트](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33) 를 다운로드하여 디스크 및 백업 일정 선택의 영향을 확인합니다.

### <a name="backup-throughput"></a>Backup 처리량
백업 중인 각 디스크에 대해 Azure Backup은 디스크의 블록을 읽고 변경 된 데이터(증분 백업)만 저장합니다. 다음 표에서 평균 Backup 서비스 처리량 값을 보여 줍니다. 다음 데이터를 사용하여 지정된 크기의 디스크 백업에 필요한 시간을 예상할 수 있습니다.

| Backup 작업 | 최상의 처리량 |
| --- | --- |
| 초기 백업 |160Mbps |
| 증분 백업(DR) |640Mbps  <br><br> 변경된 데이터(백업이 필요한)가 디스크에서 분산되어 있는 경우에는 처리량이 크게 저하됩니다.|

## <a name="total-vm-backup-time"></a>총 VM 백업 시간
대부분의 백업 시간은 데이터를 읽고 쓰는 데 사용되지만, VM을 백업하는 데 필요한 총 시간에는 다른 작업도 포함됩니다.

* [백업 확장 설치 또는 업데이트](backup-azure-arm-vms.md)하는 데 필요한 시간
* 스냅숏 시간 - 스냅숏을 트리거하는 데 걸리는 시간입니다. 스냅숏은 예약된 백업 시간에 가깝게 트리거됩니다.
* 큐 대기 시간입니다. Backup 서비스는 여러 고객의 백업을 처리하기 때문에 스냅숏의 백업 데이터를 백업 또는 Recovery Services 자격 증명 모음에 복사하는 작업이 즉시 시작되지 않을 수도 있습니다. 사용량이 많은 시간에는 처리되는 백업 수로 인해 대기가 최대 8시간까지 연장될 수 있습니다. 그러나 일별 백업 정책의 경우 총 VM 백업 시간은 24시간 미만입니다. <br>
**이는 증분 백업에만 유효하며, 첫 번째 백업에는 유효하지 않습니다. 첫 번째 백업 시간은 비례하며, 데이터 크기 및 백업 수행 시간에 따라 24시간을 초과할 수 있습니다.**
* 데이터 전송 시간은 이전 백업에서 증분 변경 내용을 계산하고 해당 변경 내용을 자격 증명 모음 저장소에 전송하는 백업 서비스에 필요한 시간입니다.

### <a name="why-am-i-observing-longer12-hours-backup-time"></a>백업 시간이 길어진(12시간 초과) 이유는 무엇인가요?
Backup은 자격 증명 모음에 스냅숏 만들기 및 스냅숏 전송과 같은 두 단계로 구성됩니다. Backup 서비스는 저장소에 최적화됩니다. 스냅숏 데이터를 자격 증명 모음으로 이전할 경우 서비스는 이전 스냅숏에서 증분 변경 사항만 이전합니다.  증분 변경을 확인하기 위해 컴퓨터는 블록의 체크섬을 계산합니다. 블록이 변경되면 해당 블록은 자격 증명 모음으로 전송될 블록으로 식별됩니다. 그런 다음 서비스는 식별된 각 블록을 더 분석하여 전송할 데이터를 최소화할 기회를 찾습니다. 모든 변경된 블록을 평가한 후 서비스는 변경 사항을 취합하여 자격 증명 모음으로 보냅니다. 일부 레거시 응용 프로그램의 경우 소규모의 조각난 쓰기는 저장소에 적합하지 않습니다. 스냅숏에 많은 소규모의 조각난 쓰기가 포함되어 있을 경우 서비스는 응용 프로그램에서 기록한 데이터를 처리하는 데 추가적인 시간을 소비합니다. VM 내에서 실행되는 응용 프로그램의 경우 Azure에서 권장되는 응용 프로그램 쓰기 블록은 최소 8KB입니다. 응용 프로그램에서 8KB 보다 작은 블록을 사용할 경우 백업 성능에 영향을 미칩니다. 백업 성능을 개선하도록 응용 프로그램을 조정하려면 [Azure Storage에서 최적의 성능을 위한 응용 프로그램 조정](../virtual-machines/windows/premium-storage-performance.md)을 참조하세요. 백업 성능에 관한 문서에서는 프리미엄 저장소 예제를 사용하고 있지만 해당 지침은 표준 저장소 디스크에 적용 가능합니다.

## <a name="total-restore-time"></a>총 복원 시간
복원 작업은 두 가지 기본 하위 작업으로 구성됩니다(볼트에서 선택한 고객 저장소 계정으로 데이터를 다시 복사 및 가상 시스템 만들기). 볼트에서 데이터를 다시 복사하는 것은 백업이 Azure에 내부적으로 저장되는 위치와 고객 저장소 계정이 저장되는 위치에 따라 다릅니다. 데이터를 복사하는 데 걸리는 시간은 다음에 따라 다릅니다.
* 큐 대기 시간 - 서비스가 동시에 여러 고객의 복원을 처리하므로 복원 요청이 큐에 배치됩니다.
* 데이터 복사 시간 - 데이터가 자격 증명 모음에서 고객 저장소 계정으로 복사됩니다. 복원 시간은 Azure Backup 서비스가 선택된 고객 저장소 계정에서 가져오는 IOPS 및 처리량에 따라 달라집니다. 복원 과정 중 복사 시간을 단축하려면 다른 응용 프로그램 쓰기 및 읽기로 로드되지 않은 저장소 계정을 선택하세요.

## <a name="best-practices"></a>모범 사례
가상 머신에 대한 백업을 구성하는 동안 다음 사례를 따르는 것이 좋습니다.

* 동일한 클라우드 서비스에서 10개가 넘는 클래식 VM을 동시에 백업하도록 예약하지 마세요. 동일한 클라우드 서비스에서 여러 VM을 백업하려면 백업 시작 시간에 한 시간의 시차를 두는 것이 좋습니다.
* 40개 이상의 VM을 동시에 백업하도록 예약하지 마세요.
* 사용량이 많지 않은 시간에 VM 백업을 예약하세요. 그러면 Backup 서비스가 고객 저장소 계정에서 자격 증명 모음으로 데이터를 전송할 때 IOPS를 사용합니다.
* 정책이 서로 다른 저장소 계정에 분산된 VM에 적용되어야 합니다. 권장 단일 저장소 계정에서 20개 이하의 총 디스크를 동일한 백업 일정으로 보호하는 것이 좋습니다. 저장소 계정에 20개가 넘는 디스크가 있는 경우 해당 VM을 여러 정책에 분산하여 백업 프로세스의 전송 단계에서 필요한 IOPS를 얻습니다.
* 프리미엄 저장소에서 실행되는 VM을 동일한 저장소 계정에 복원하지 마세요. 복원 작업 프로세스가 백업 작업과 일치하는 경우 백업에 사용할 수 있는 IOPS를 감소시킵니다.
* 프리미엄 VM 백업의 경우 프리미엄 디스크를 호스트하는 저장소 계정에 성공적인 백업을 위해 스냅샷 준비에 사용할 50% 이상의 사용 가능한 공간이 있는지 확인합니다. 
* 백업에 사용할 수 있는 Linux VM의 python 버전이 2.7인지 확인합니다.

## <a name="data-encryption"></a>데이터 암호화.
Azure Backup은 백업 프로세스의 일부로 데이터를 암호화하지 않습니다. 그러나 VM 내에서 원활하게 데이터를 암호화하고 보호되는 데이터를 백업할 수 있습니다( [암호화된 데이터 백업](backup-azure-vms-encryption.md)에 대해 자세히 알아보기).

## <a name="calculating-the-cost-of-protected-instances"></a>보호된 인스턴스 비용 계산
Azure Backup을 통해 백업된 Azure 가상 머신에는 [Azure Backup 가격](https://azure.microsoft.com/pricing/details/backup/)이 적용됩니다. 보호된 인스턴스 계산은 가상 머신의 *실제* 크기를 기반으로 하며, 임시 저장소를 제외한 가상 머신의 모든 데이터 합계입니다.

VM 백업에 대한 가격 책정은 가상 머신에 연결된 각 데이터 디스크의 최대 지원 크기에 따라 결정되는 것이 아니라, 데이터 디스크에 저장된 실제 데이터에 따라 청구됩니다. 마찬가지로, 백업 저장소 요금은 Azure Backup을 사용하여 저장된 데이터 양(각 복구 지점의 실제 데이터 합계)을 기준으로 청구됩니다.

최대 크기가 각각 1TB인 두 개의 추가 데이터 디스크가 있는 A2 표준 크기 가상 머신을 예로 들 수 있습니다. 다음 표는 각 디스크에 저장된 실제 데이터를 제공합니다.

| 디스크 유형 | 최대 크기 | 실제 데이터 표시 |
| --------- | -------- | ----------- |
| 운영 체제 디스크 |1023GB |17GB |
| 로컬 디스크/임시 디스크 |135GB |5GB(백업에 포함되지 않음) |
| 데이터 디스크 1 |1023GB |30GB |
| 데이터 디스크 2 |1023GB |0GB |

이 경우 가상 머신의 실제 크기는 17GB+30GB+0GB=47GB입니다. 이 보호된 인스턴스 크기(47GB)는 월별 청구서의 근거가 됩니다. 가상 머신의 데이터 양이 증가하면 요금 청구에 사용되는 보호된 인스턴스 크기도 그에 따라 변경됩니다.

요금 청구는 첫 번째 백업이 성공적으로 완료되기 전까지 시작되지 않습니다. 이때 저장소와 보호된 인스턴스 둘 다에 대한 요금 청구가 시작됩니다. 가상 머신의 백업 데이터가 자격 증명 모음에 저장되어 있는 한 요금이 계속 청구됩니다. 가상 머신의 보호를 중지하더라도 자격 증명 모음에 가상 머신 백업 데이터가 있으면 요금이 계속 청구됩니다.

지정된 가상 머신에 대한 요금 청구는 보호가 중지되고 모든 백업 데이터가 삭제된 경우에만 중단됩니다. 보호가 중지되고 활성 백업 작업이 없으면 마지막으로 성공한 VM 백업이 월별 청구에 사용되는 보호된 인스턴스 크기가 됩니다.

## <a name="questions"></a>질문이 있으십니까?
질문이 있거나 포함되었으면 하는 기능이 있는 경우 [의견을 보내 주세요](http://aka.ms/azurebackup_feedback).

## <a name="next-steps"></a>다음 단계
* [가상 머신 설정](backup-azure-arm-vms.md)
* [가상 머신 백업 관리](backup-azure-manage-vms.md)
* [가상 머신 복원](backup-azure-arm-restore-vms.md)
* [VM 백업 문제 해결](backup-azure-vms-troubleshoot.md)
